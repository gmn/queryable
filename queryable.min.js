(function(queryable){"use strict";var p=function(s){console.log(s)};function type_of(t){var s=typeof t;switch(s){case"object":if(t instanceof Date){return"date"}else if(t instanceof Array){return"array"}else if(t instanceof RegExp){return"regexp"}default:return s}}function classof(o){if(o===null)return"Null";if(o===undefined)return"Undefined";return Object.prototype.toString.call(o).slice(8,-1)}function detect_platform(){var platform="unknown";try{if(exports!==undefined)platform="node_module"}catch(e){try{if(window!==undefined)platform="browser"}catch(e){}}return platform}function clip_all_leading(str,clip){while(str.length&&str.charAt(0)===clip){str=str.substring(clip.length,str.length)}return str}function _firstKey(O){for(var i in O){if(O.hasOwnProperty(i))return i}return null}function _getKeys(O){var keys=[];if(type_of(O)!=="object")return null;for(var i in O){if(O.hasOwnProperty(i)){var _val=type_of(O[i])==="object"?_getKeys(O[i]):O[i];if(type_of(_val)==="array"&&_val.length===1)_val=_val[0];keys.push({key:i,value:_val})}}return keys}function sortObjectByKeys(O){if(typeof O!=="object"||O instanceof Array)return O;var keys=[];for(var i in O){if(O.hasOwnProperty(i)){keys.push({key:i,value:O[i]})}}if(keys.length===0)return O;keys.sort(function(a,b){return a.key<b.key?-1:1});var nO={};keys.forEach(function(item){nO[item.key]=item.value});return nO}function addToFront(obj,_key,_value){if(typeof obj!=="object")return obj;var keys=[];for(var key in obj){if(obj.hasOwnProperty(key)){keys.push(key)}}if(keys.length===0)return obj;var newObj={};newObj[_key]=_value;keys.forEach(function(key){newObj[key]=obj[key]});return newObj}function sortArrayOfObjectsByKeys(array_of_objs){if(type_of(array_of_objs)!=="array")return array_of_objs;if(array_of_objs.length===0)return array_of_objs;array_of_objs.forEach(function(val,index,ary){ary[index]=sortObjectByKeys(val)});array_of_objs.sort(function(a,b){return _firstKey(a)<_firstKey(b)?-1:1});return array_of_objs}function db_result(arg){this.length=0;this.rows=[];if(arguments.length===1&&type_of(arg)==="array"){for(var i=0,l=arg.length;i<l;i++){this.push(arg[i])}}}db_result.prototype={push:function(O){if(type_of(O)==="object")this.rows.push(JSON.parse(JSON.stringify(O)));this.length=this.rows.length;return this},sort:function(O){var key=_firstKey(O);var val=O[key];this.rows.sort(function(a,b){if(!a[key])return-val;else if(!b[key])return val;if(typeof a[key]==="string"&&typeof b[key]==="string")return a[key].localeCompare(b[key])*val;else return a[key]>b[key]?val:-val});return this},limit:function(_l){var lim=Number(_l);if(type_of(lim)!=="number")return this;this.rows.splice(lim,this.rows.length-lim);this.length=this.rows.length;return this},skip:function(s){var skp=Number(s);if(type_of(skp)!=="number")return this;this.rows.splice(0,skp);this.length=this.rows.length;return this},count:function(){return this.rows.length},getArray:function(){return this.rows},get_json:function(fmt){if(arguments.length===0)return JSON.stringify(this.rows);return JSON.stringify(this.rows,null,fmt)},print:function(fmt){var f=arguments.length===0?"  ":fmt;console.log(this.get_json(f))}};function db_object(config){this.platform=config.platform;this.db_path=config.db_path;this.db_dir=config.db_dir;this.db_name=config.db_name;this.use_gzip=config.use_gzip||false;this.master=[];this._id=0;if(config.data){if(type_of(config.data)=="array")this.master=config.data;else if(type_of(config.data)=="string")this.master=JSON.parse(config.data);else console.log("queryable: error: Could not determine input data type\n");finish_db_setup.call(this)}else if(this.platform==="browser"){var name=this.db_name.trim();this.db_name=!name||name.length===0||name==="test.db"?"queryable":name;if(window.localStorage&&localStorage.hasOwnProperty(this.db_name)){var string=localStorage[this.db_name];this.master=JSON.parse(string)}finish_db_setup.call(this)}else if(this.platform==="node_module"){var fs=require("fs");if(this.db_path.lastIndexOf(".gz")===this.db_path.length-3)this.use_gzip=true;if(fs.existsSync(this.db_path)){var was_gzip=false;if(this.use_gzip){try{var gzbz=require("gzbz");var gunzip=new gzbz.Gunzip;gunzip.init({encoding:"utf8"});var gzdata=fs.readFileSync(this.db_path,{encoding:"binary",flag:"r"});var inflated=gunzip.inflate(gzdata,"binary");gunzip.end();this.master=JSON.parse(inflated);finish_db_setup.call(this);return}catch(e){this.use_gzip=false;console.log("warning: tried to open as gzip without gzbz module present. Trying normal.");was_gzip=true}}try{var data=fs.readFileSync(this.db_path,{encoding:"utf8",flag:"r"});this.master=JSON.parse(data);finish_db_setup.call(this)}catch(e){var msg='error: "'+this.db_path+'" failed to open.';console.log(msg);process.exit(-1)}}}function finish_db_setup(){if(this.master.length>0){var highest=0;var any_missing=false;this.master.forEach(function(row){if(row["_id"]===undefined)any_missing=true;else if(row["_id"]>highest){highest=row["_id"]}});if(any_missing){for(var i=0,l=this.master.length;i<l;i++){if(this.master[i]["_id"]===undefined){this.master[i]=addToFront(this.master[i],"_id",++highest)}}}this._id=highest;this.master=this.master.sort(function(a,b){return a._id-b._id})}}}db_object.prototype={save:function(arg1,arg2){var _mode=undefined;var callback=undefined;if(arguments.length===1){if(type_of(arg1)==="function"){callback=arg1}else{var num=Number(arg1);if(!isNaN(num)){_mode=num}else{throw new Error("save: accepts 0, 1 or 2 arguments, eg.: save(), save(mode), save(mode,callback), or save(callback)")}}}else if(arguments.length===2){if(type_of(arg2)!=="function")throw new Error("save: usage: save(mode, callback)");callback=arg2;var num=Number(arg1);if(!isNaN(num)){_mode=num}else{throw new Error("save: accepts 0, 1 or 2 arguments, eg.: save(), save(mode), save(mode,callback), or save(callback)")}}if(this.platform==="node_module"){var mode=_mode||438;var fs=require("fs");var use_async=false;var gzip_lvl=1;if(this.use_gzip){try{if(use_async){var ostream=fs.createWriteStream(this.db_path);var zlib=require("zlib");var Stream=require("stream");var in_stream=new Stream;in_stream.pipe(zlib.createGzip()).pipe(ostream);in_stream.emit("data",JSON.stringify(this.master));in_stream.emit("end")}else{var gzbz=require("gzbz");var gzip=new gzbz.Gzip;gzip.init({encoding:"binary",level:gzip_lvl});var gz1=gzip.deflate(JSON.stringify(this.master));var gz2=gzip.end();var gzdata=gz1+gz2;fs.writeFileSync(this.db_path,gzdata,{encoding:"binary",mode:mode,flag:"w"})}return this.__return(true,callback)}catch(e){return this.__return(e,callback)}}try{fs.writeFileSync(this.db_path,JSON.stringify(this.master),{encoding:"utf8",mode:mode,flag:"w"})}catch(e){throw new Error('save: failed writing: "'+this.db_path+'" '+e.toString())}}else if(this.platform==="browser"){localStorage[this.db_name]=JSON.stringify(this.master)}return this.__return(true,callback)},insert:function(Arg,callback){if(arguments.length!==1&&arguments.length!==2)throw new Error("insert: accepts 1 or 2 arguments: insert(row [,callback])");var that=this;function insert_one(obj){if(type_of(obj)!=="object")throw new Error("insert: row element must be Object");if(!obj["_id"])obj=addToFront(obj,"_id",++that._id);that.master.push(obj);return 1}var num_rows=0;if(type_of(Arg)==="array"){for(var i=0,l=Arg.length;i<l;i++){num_rows+=insert_one(Arg[i])}}else if(type_of(Arg)==="object"){num_rows+=insert_one(Arg)}else{throw new Error("insert: accepts Object or Array of Objects")}return this.__return(num_rows,callback)},update:function(query,_update,options,callback){if(arguments.length<2)throw new Error("usage: update(query,update,[options],[callback])");if(type_of(query)!=="object"||type_of(_update)!=="object")throw new Error("usage: update(query,update,[options],[callback])");if(arguments.length===3&&type_of(options)!=="object")throw new Error("usage: update(query,update,[options],[callback])");var set=_update["$set"];if(!set)throw new Error("usage: update(query,update,[options],[callback])");var res=this.do_query(query);var do_multi=false,do_upsert=false;if(options){do_multi=options["multi"]?options["multi"]:false;do_upsert=options["upsert"]?options["upsert"]:false}if(res.length===0&&do_upsert){this.insert(set);return this.__return(1,callback)}var rows_altered=0;for(var i=0,l=res.length;i<l;i++){var row=res[i];var did_change=false;for(var j in set){if(set.hasOwnProperty(j)){var key=j;var value=set[j];if(!row[key]||row[key]!==value){row[key]=value;did_change=true}}}if(did_change)++rows_altered;if(!do_multi)break}return this.__return(rows_altered,callback)},find:function(match,callback){if(!match)match={};if(arguments.length>2||type_of(match)!=="object")throw new Error("find: usage: find([match],[callback])");var res=this.do_query(match);var dbres=new db_result(res);return this.__return(dbres,callback)},distinct:function(str,clause,callback){if(str===undefined)throw new Error("usage: distinct(key,[clause],[callback])");if(clause){var res=this.do_query(clause)}else{var res=this.do_query()}var set_wo=[];var maybe=[];for(var i=0,l=res.length;i<l;i++){if(res[i][str]!==undefined){maybe.push(res[i])}}var distinct_set=[];for(var i=0,l=maybe.length;i<l;i++){if(!distinct_set.some(function(x){return x[str]===maybe[i][str]}))distinct_set.push(maybe[i])}var dbres=new db_result(distinct_set);res=null;return this.__return(dbres,callback)},remove:function(constraints,callback){if(arguments.length===0)var constraints={};if(type_of(constraints)!=="object")throw new Error("usage: remove( [constraints], [callback] )");var rows=this.do_query(constraints);if(rows.length===0)return this.__return(0,callback);var rmids=[];for(var i=0,l=rows.length;i<l;i++){var id=rows[i]["_id"];if(!id)continue;rmids.push(id)}if(rmids.length===0)return this.__return(0,callback);var rows_altered=0;var new_master=this.master.filter(function(row){for(var i=0,l=rmids.length;i<l;i++){if(row["_id"]&&row["_id"]===rmids[i]){++rows_altered;return false}}return true});if(rows_altered>0)this.master=new_master;return this.__return(rows_altered,callback)},get_json:function(){return JSON.stringify(this.master)},print:function(fmt){var f=arguments.length===0?"  ":fmt;console.log(JSON.stringify(this.master,null,f))},now:function(){var n=new Date;if(n.toISOString&&typeof n.toISOString==="function"){return n.toISOString()}return n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate()+"T"+n.toUTCString().replace(/.*(\d\d:\d\d:\d\d).*/,"$1")+".000Z"},toDate:function(isostring){return new Date(isostring)},count:function(){return this.master.length},renormalize:function(){for(var i=0,l=this.master.length;i<l;i++){this.master[i]=sortObjectByKeys(this.master[i])}this.master.sort(function(a,b){return a._id-b._id});for(var i=0,l=this.master.length;i<l;i++){this.master[i]._id=1+i}},__return:function(arg,callback){if(callback)return callback(arg);return arg},detect_clause_type:function(key,value){switch(type_of(value)){case"boolean":case"date":case"number":case"string":case"regexp":return key.indexOf(".")===-1?"CLAUSE_NORMAL":"CLAUSE_SUBDOCUMENT_MATCH";case"object":var fk=_firstKey(value);switch(fk){case"$gt":case"$gte":case"$lt":case"$lte":case"$exists":case"$ne":return"CLAUSE_CONDITIONAL";default:return"CLAUSE_SUBDOCUMENT"}break;case"array":return key==="$or"?"CLAUSE_OR":"CLAUSE_ARRAY";default:break}return"CLAUSE_UNKNOWN"},matching_rows_NORMAL:function(test,rows){var res=[];var i=0;next_row:for(var l=rows.length;i<l;i++){var row=rows[i];for(var key in row){if(row.hasOwnProperty(key)&&key===test.key){if(type_of(test.value)==="regexp"){var sval=row[key]+"";if(sval.match(test.value)){res.push(row);continue next_row}}else{if(row[key]===test.value){res.push(row);continue next_row}}}}}return res},matching_rows_CONDITIONAL:function(test,rows){var res=[];var i=0;var cond=_firstKey(test.value);next_row:for(var l=rows.length;i<l;i++){var row=rows[i];if(cond==="$exists"){if(test.value[cond]){if(row[test.key]){res.push(row);continue next_row}}else{if(!row[test.key]){res.push(row);continue next_row}}continue next_row}if(cond==="$ne"){if(!row[test.key]){res.push(row);continue next_row}else if(row[test.key]!==test.value["$ne"]){res.push(row);continue next_row}}for(var key in row){if(row.hasOwnProperty(key)&&key===test.key){switch(cond){case"$lt":if(row[key]<test.value[cond]){res.push(row);continue next_row}break;case"$lte":if(row[key]<=test.value[cond]){res.push(row);continue next_row}break;case"$gt":if(row[key]>test.value[cond]){res.push(row);continue next_row}break;case"$gte":if(row[key]>=test.value[cond]){res.push(row);continue next_row}break;case"$ne":if(row[key]!==test.value[cond]){res.push(row);continue next_row}break;default:break}}}}if(cond)delete test.value[cond];return res},matching_rows_OR:function(array,rows){var res=[];var i=0;next_row:for(var l=rows.length;i<l;i++){var row=rows[i];for(var j=0,la=array.length;j<la;j++){var eltkey=_firstKey(array[j]);var eltval=array[j][eltkey];var test={key:eltkey,value:eltval};var clausetype=this.detect_clause_type(eltkey,eltval);switch(clausetype){case"CLAUSE_NORMAL":if(type_of(test.value)==="regexp"){if(row[test.key]&&row[test.key].match(test.value)){res.push(row);continue next_row}}else{if(row[test.key]===test.value){res.push(row);continue next_row}}break;case"CLAUSE_CONDITIONAL":switch(_firstKey(test.value)){case"$gt":if(row[test.key]>test.value["$gt"]){res.push(row);continue next_row}break;case"$gte":if(row[test.key]>=test.value["$gte"]){res.push(row);continue next_row}break;case"$lt":if(row[test.key]<test.value["$lt"]){res.push(row);continue next_row}break;case"$lte":if(row[test.key]<=test.value["$lte"]){res.push(row);continue next_row}break;case"$exists":if(row[test.key]!==undefined&&test.value["$exists"]){res.push(row);continue next_row}else if(row[test.key]===undefined&&!test.value["$exists"]){res.push(row);continue next_row}break}break;default:break}}}return res},do_query:function(clauses){var result=this.master;if(!clauses||type_of(clauses)==="object"&&_firstKey(clauses)===null){return result}next_clause:for(var clause in clauses){if(!clauses.hasOwnProperty(clause))continue next_clause;var clausetype=this.detect_clause_type(clause,clauses[clause]);switch(clausetype){case"CLAUSE_NORMAL":result=this.matching_rows_NORMAL({key:clause,value:clauses[clause]},result);break;case"CLAUSE_CONDITIONAL":while(_firstKey(clauses[clause])!==null){result=this.matching_rows_CONDITIONAL({key:clause,value:clauses[clause]},result)}break;case"CLAUSE_OR":result=this.matching_rows_OR(clauses[clause],result);break;default:break}}return result},sortMaster:function(){sortArrayOfObjectsByKeys(this.master)}};queryable.open=function(config){var that=this;this.platform=detect_platform();switch(this.platform){case"node_module":var path=require("path");var fs=require("fs");this.db_name="test.db";this.db_dir=path.resolve(__dirname);this.db_path=0;this.use_gzip=false;return server_open(config);case"browser":var _name="";var data=undefined;if(type_of(config)==="string")_name=config;else if(type_of(config)==="object"){_name=config&&config.db_name?config.db_name:"";if(config.string)data=config.string;else if(config.data)data=config.data}if(data)return new db_object({platform:"browser",db_name:_name,data:data});else return new db_object({platform:"browser",db_name:_name});default:p("unknown platform");return queryable}function server_open(config){var parm_list=["db_name","db_dir","db_path","use_gzip"];if(arguments.length>0&&typeof config==="string"){try{var data=fs.readFileSync(config,{encoding:"utf8",flag:"r"});that.db_path=path.resolve(config);that.db_name=clip_all_leading(that.db_path.substring(that.db_path.lastIndexOf("/"),that.db_path.length),"/");that.db_dir=that.db_path.substring(0,that.db_path.lastIndexOf(that.db_name))}catch(e){switch(e.code){case"ENOENT":that.db_path=path.resolve(config);that.db_name=clip_all_leading(that.db_path.substring(that.db_path.lastIndexOf("/"),that.db_path.length),"/");that.db_dir=that.db_path.substring(0,that.db_path.lastIndexOf(that.db_name));break;case"EISDIR":that.db_dir=path.resolve(config);break;default:break}}}else if(arguments.length>0&&typeof config==="object"){for(var i=0;i<parm_list.length;i++){if(config[parm_list[i]]){if(parm_list[i]==="db_path")config[parm_list[i]]=path.resolve(config[parm_list[i]]);else if(parm_list[i]==="db_dir")config[parm_list[i]]=path.resolve(config[parm_list[i]]);else if(parm_list[i]==="db_name")config[parm_list[i]]=clip_all_leading(config[parm_list[i]],"/");that[parm_list[i]]=config[parm_list[i]]}}if(config.db_path){var _n=clip_all_leading(that.db_path.substring(that.db_path.lastIndexOf("/"),that.db_path.length),"/");var _d=that.db_path.substring(0,that.db_path.lastIndexOf(_n));var _any_changed=0;if(_n!==that.db_name){that.db_name=_n;++_any_changed}if(_d!==that.db_dir){that.db_dir=_d;++_any_changed}if(_any_changed){that.db_path=0}}}if(!that.db_path){if(that.db_dir&&that.db_dir[that.db_dir.length-1]==="/")that.db_path=that.db_dir+that.db_name;else that.db_path=that.db_dir+"/"+that.db_name}var rows=config&&config.data?config.data:undefined;return new db_object({db_path:that.db_path,db_dir:that.db_dir,db_name:that.db_name,platform:that.platform,use_gzip:that.use_gzip,data:rows})}};queryable.useGzip=function(){if(arguments.length>0){this.use_gzip=arguments[0]}};try{if(window)window.queryable=queryable}catch(e){}return queryable})(typeof exports==="undefined"?{}:exports);